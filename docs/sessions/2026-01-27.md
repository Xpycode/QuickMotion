# Session: 2026-01-27

## Goal
Phase 4 Polish + IN/OUT Trim Feature

## Context
- Previous session: Export window complete, keyboard controls working
- Current phase: implementation (Phase 4 of 5)

## Progress

### Morning: Error Handling & Window Persistence
- [x] Audited export error handling - found gaps in disk space and error messaging
- [x] Added pre-flight disk space check with 10% safety buffer
- [x] Created user-friendly error message mapping for AVFoundation errors
- [x] Added new ExportError cases: `insufficientDiskSpace`, `permissionDenied`, `diskWriteError`
- [x] Confirmed file overwrite warning handled by NSSavePanel automatically
- [x] Added window position persistence for main window
- [x] Added window position persistence for export window
- [x] Created WindowAccessor helper for SwiftUI window access

### Afternoon: IN/OUT Trim Points Feature
- [x] Added `inPoint`/`outPoint` properties to AppState with boundary observers
- [x] Implemented `setInPoint()`, `setOutPoint()`, `clearTrimPoints()` methods
- [x] Added I/O/X keyboard shortcuts for trim control
- [x] Constrained playback to loop within trim bounds using `AVPlayerItem.forwardPlaybackEndTime`
- [x] Updated scrubber to show full timeline with yellow trim overlay (QuickTime-style)
- [x] Added rounded corners and proper alignment to trim overlay
- [x] Updated duration display to show trimmed duration when trim is active
- [x] Export now uses trimmed CMTimeRange via `insertTimeRange()`
- [x] Fixed bundle identifier to `com.lucesumbrarum.quickmotion`
- [x] Fixed Xcode warning: `ALWAYS_SEARCH_USER_PATHS = NO`
- [x] Fixed layout shift when trim indicator appears (overlay vs ZStack, opacity vs conditional)

### Files Modified
- `ViewModels/AppState.swift` - trim state, boundary observers, playback constraints
- `ViewModels/ExportSession.swift` - trim parameters, uses trimmed time range
- `Views/PreviewAreaView.swift` - yellow trim overlay, constrained scrubber
- `ContentView.swift` - I/O/X shortcuts, trimmed duration display, pass trim to export
- `Config/Shared.xcconfig` - bundle identifier
- `project.pbxproj` - ALWAYS_SEARCH_USER_PATHS setting

## Decisions
- Non-destructive trim: original video unchanged, clear IN/OUT restores full access
- `AVPlayerItem.forwardPlaybackEndTime` + boundary observer for trim playback
- Yellow trim overlay similar to QuickTime's trim mode
- I key = IN, O key = OUT, X key = clear (industry standard)
- Export uses `insertTimeRange` with trimmed CMTimeRange

## Commits
- `60db7cc` - Add disk space pre-check and friendly error messages
- `3d93371` - Add window position persistence
- `24d4381` - Update project state: Phase 4 at 80%
- `62b1658` - Add session log for 2026-01-27
- `9cbbce4` - Fix layout shift when trim indicator appears

## Next
- Test trim feature with various videos
- Format testing with various codecs/resolutions
- App icon design

## Notes
- Phase 4 complete with trim feature
- Phase 5 nice-to-haves: batch processing, project save/restore
- Trim feature makes app significantly more useful for long videos

### SwiftUI Layout Stability Pattern
For elements that appear/disappear without shifting siblings:
- Use `.overlay` instead of `ZStack` - overlay content excluded from parent sizing
- Use `opacity(0/1)` instead of `if` conditionals - keeps view in tree, no structural identity change
- Reserve space with fixed padding even when content hidden
