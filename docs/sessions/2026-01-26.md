# Session: 2026-01-26

## Goal
Implement AVPlayer-based preview refactor, keyboard speed controls, loop toggle, and plan export window.

## Context
- Previous session: Planned AVPlayer.rate replacement for frame extraction
- Current phase: implementation

## Progress

### Completed
- [x] Wave 1: Created VideoPlayerView (NSViewRepresentable wrapper)
- [x] Wave 1: Updated AppState to use AVPlayer instead of frame extraction
- [x] Wave 2: Rewrote PreviewAreaView with VideoPlayerView and time-based scrubber
- [x] Wave 2: Verified SpeedSliderView works with instant rate changes
- [x] Wave 3: Deleted PreviewEngine.swift (no longer needed)
- [x] Wave 3: Deleted Debouncer.swift (no longer needed)
- [x] Wave 3: Added high-speed hint overlay (shows above 50x)
- [x] Wave 4: Build verification passed
- [x] Initial commit: `a861d32`
- [x] Created `playback` branch for keyboard controls feature

### Completed (continued)
- [x] Wave 1: Added SpeedMode enum (linear, multiplicative, presets)
- [x] Wave 1: Disabled auto-play on video load
- [x] Wave 2: Added J/K/L keyboard handling via `.onKeyPress`
- [x] Wave 2: Added segmented control for speed mode selection
- [x] Wave 2: Added context menu on slider with mode options
- [x] Wave 3: Added speed text animation with `.contentTransition(.numericText())`
- [x] Wave 3: Logged reverse playback idea to docs/ideas.md
- [x] Wave 4: Build verification passed
- [x] Commit: `0e344bb` - keyboard speed controls complete
- [x] Added loop toggle button (on by default, dims when off)
- [x] Fixed: video starts paused on load
- [x] Fixed: enabling loop at video end seeks to start
- [x] Commit: `3f7f65e` - loop toggle
- [x] Merged `playback` branch to main: `e67c67f`
- [x] Planned Phase 3: Export window with smart presets
- [x] Fixed: blue focus ring around window (added `.focusEffectDisabled()`)

### Discovered
- AVPlayer.rate works smoothly up to 50x on macOS 14+
- Preview duration now matches actual export duration
- Workspace build required (not project-only build)
- `.onKeyPress` with closure works better than individual key handlers
- `.focusable()` adds visible focus ring - use `.focusEffectDisabled()` to hide it

### Decisions Made
- AVPlayer.rate replaces frame extraction → instant speed changes
- Three speed modes: Linear (±1/±10), Multiplicative (×1.5/×2), Presets
- J/K/L keys with Shift modifier for speed control
- Mode toggle via segmented control + context menu on slider
- Default mode: multiplicative (×1.5 feels natural)
- Loop toggle: on by default, user can disable
- Export window (not sheet) preferred over slideouts
- Export runs independently so user can work on next file
- Smart presets: Fast (HEVC), Quality (ProRes), Match Original

### Phase 3: Export Window Implementation ✅
- [x] Wave 1: Created ExportSettings model (quality, resolution, frameRate enums)
- [x] Wave 1: Created ExportSession class (@Observable, state machine)
- [x] Wave 2: Created ExportSettingsView (quality picker, output folder, advanced options)
- [x] Wave 2: Created ExportProgressView (progress bar, elapsed/remaining time)
- [x] Wave 2: Created ExportCompleteView (success/failure states)
- [x] Wave 2: Created ExportWindow container (switches between views)
- [x] Wave 3: Implemented AVMutableComposition export with time scaling
- [x] Wave 3: Wired Export button in ContentView
- [x] Wave 4: Improved file size estimation (codec-aware multipliers)
- [x] Wave 4: Added source codec detection (FourCC → display name)
- [x] Fixed: Empty sheet issue (changed to .sheet(item:))
- [x] Fixed: Sheet sizing issues → changed to proper NSWindow
- [x] Removed redundant "Export Settings" menu from main window
- [x] ExportWindowController opens standalone floating window

### Files Created
- `Models/ExportSettings.swift` - Export configuration enums and struct
- `ViewModels/ExportSession.swift` - Export state machine with AVAssetExportSession
- `Views/Export/ExportSettingsView.swift` - Settings UI
- `Views/Export/ExportProgressView.swift` - Progress UI
- `Views/Export/ExportCompleteView.swift` - Success/failure UI
- `Views/Export/ExportWindow.swift` - Container view
- `Views/Export/ExportWindowController.swift` - NSWindow management

### Decisions Made (Phase 3)
- Standalone NSWindow (not sheet) for export - better UX, proper sizing
- Export session independent of AppState - user can load new file while exporting
- Quality presets: Fast (HEVC/.mp4), Quality (ProRes/.mov), Match Original
- Time scaling via AVMutableComposition.scaleTimeRange()
- Progress tracking via Timer polling AVAssetExportSession.progress

### Export Bug Fixes (Session 2)
- [x] Fixed sandbox permissions: changed entitlement to `read-write`
- [x] Fixed missing local package reference in project.pbxproj
- [x] Added security-scoped resource access (`startAccessingSecurityScopedResource`)
- [x] Fixed settings not propagating to session (outputURL, includeAudio, quality)
- [x] Changed Export button to use NSSavePanel for proper write permissions
- [x] Added audio export option with fast `.varispeed` algorithm
- [x] Cleaned up export window UI (removed duplicate title, fixed alignment, friendly folder names)
- [x] Commit: `818e73c` - export functionality complete

### Decisions Made (Export Fixes)
- NSSavePanel required for sandbox write permissions (drop only grants read)
- Audio uses `.varispeed` algorithm (fast, chipmunk effect) vs slow `.spectral`
- Settings now mutable on ExportSession to allow UI changes to propagate

## Next Session
- Consider window positioning/restoration
- Handle edge cases (disk full, existing file overwrite warning)
- Test with various video formats and sizes

## Notes
- Build command: `xcodebuild -scheme QuickMotion build` (fixed package reference)
- Reverse playback logged as future idea
- PLAN.md can be deleted
